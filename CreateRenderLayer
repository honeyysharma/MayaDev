'''
Script to test automation of render layers setup
@author: sharmah
'''

##import render setup and maya commands modules
import maya.app.renderSetup.model.renderSetup as renderSetup
import maya.app.renderSetup.model.override as override
import maya.app.renderSetup.model.selector as selector
import maya.app.renderSetup.model.collection as collection
import maya.app.renderSetup.model.renderLayer as renderLayer
import maya.app.renderSetup.model.override as override
import maya.app.renderSetup.model.renderLayer as layer


nodes = cmds.selectedNodes()
print ("").join(cmds.selectedNodes())

"""
nodeName = str(node)
print type(nodeName)
print nodeName.replace("|","|")

print cmds.ls(node, dag=1, sn=1, showType=1)
print cmds.listRelatives(node, allParents=True)
"""


#print cmds.listRelatives(cmds.selectedNodes()[0], children=1)

def getListUptoFirstMeshNode(groupName):
    newList = []
    groupNodes = cmds.ls(groupName, dag=1)
    for node in groupNodes:
        newList.append(node)
        if cmds.nodeType(node) == 'mesh':
            break
            
    return ("".join(map((lambda node: '|'+ node), newList))) 

def createEnvirLayer(layerName):
    """create render setup instance"""
    rs = renderSetup.instance()
    
    """create and append the render layer"""
    envirLayer = rs.createRenderLayer(layerName)
    
    """create all lights collection"""
    c_allLights = envirLayer.createCollection("c_AllLights")
    c_allLights.getSelector().setFilterType(4)
    c_allLights.getSelector().setPattern("*")
    
    
    """create envir collection"""
    c_allEnvir = envirLayer.createCollection("c_envirAllEnvir")
    c_allEnvir.getSelector().setFilterType(0)
    c_allEnvir.getSelector().setPattern("ENVIR*")
    
    """create collection to turn off all chars from envir layer"""
    c_allChar = envirLayer.createCollection("c_envirAllChar")
    c_allChar.getSelector().setFilterType(0)
    c_allChar.getSelector().setPattern("CHAR*")
    o_charVisibility = c_allChar.createOverride("envirCharVisibility", override.AbsOverride.kTypeId)
    o_charVisibility.finalize(getListUptoFirstMeshNode("CHAR")+".primaryVisibility")
    o_charVisibility.setAttrValue(0)
    
    """create collection to turn off all props from main envir layer"""
    c_envirProps = envirLayer.createCollection("c_envirProps")
    c_envirProps.getSelector().setPattern("Props*")
    o_envirPropsVisibility = c_envirProps.createOverride("envirPropsVisibility", override.AbsOverride.kTypeId)
    o_envirPropsVisibility.finalize("ENVIR"+getListUptoFirstMeshNode("Props")+".primaryVisibility")
    o_envirPropsVisibility.setAttrValue(0)
    
    
    """set render layer visible"""
    rs.switchToLayer(envirLayer)
    
def createCustomEnvirLayer(layerName):
    """create render setup instance"""
    rs = renderSetup.instance()
    
    """create and append the render layer"""
    envirLayer = rs.createRenderLayer(layerName)
    
    """create all lights collection"""
    c_allLights = envirLayer.createCollection("c_AllLights")
    c_allLights.getSelector().setFilterType(4)
    c_allLights.getSelector().setPattern("*")
    
    """create envir collection"""
    c_allEnvir = envirLayer.createCollection("c_envirAllEnvir")
    c_allEnvir.getSelector().setFilterType(0)
    c_allEnvir.getSelector().setPattern("ENVIR*")
    o_envirVisibility = c_allEnvir.createOverride("customAllEnvirVisibility", override.AbsOverride.kTypeId)
    o_envirVisibility.finalize(getListUptoFirstMeshNode("ENVIR")+".primaryVisibility")
    o_envirVisibility.setAttrValue(0)
    
    
    """create envir collection"""
    c_customEnvir = envirLayer.createCollection("c_envirCustomEnvir")
    c_customEnvir.getSelector().setFilterType(0)
    c_customEnvir.getSelector().setPattern(("").join(cmds.selectedNodes()))
    o_customEnvirVisibility = c_customEnvir.createOverride("customEnvirVisibility", override.AbsOverride.kTypeId)
    o_customEnvirVisibility.finalize("ENVIR"+getListUptoFirstMeshNode(cmds.selectedNodes()[0])+".primaryVisibility")
    o_customEnvirVisibility.setAttrValue(1)
    
    """create collection to turn off all chars from envir layer"""
    c_allChar = envirLayer.createCollection("c_envirAllChar")
    c_allChar.getSelector().setFilterType(0)
    c_allChar.getSelector().setPattern("CHAR*")
    o_charVisibility = c_allChar.createOverride("envirCharVisibility", override.AbsOverride.kTypeId)
    o_charVisibility.finalize(getListUptoFirstMeshNode("CHAR")+".primaryVisibility")
    o_charVisibility.setAttrValue(0)
    
    """set render layer visible"""
    rs.switchToLayer(envirLayer)
   
    
def createCharLayer(layerName):
    """create render setup instance"""
    rs = renderSetup.instance()
    
    """create and append the render layer"""
    charLayer = rs.createRenderLayer(layerName)
    
    """create all lights collection"""
    c_allLights = charLayer.createCollection("c_AllLights")
    c_allLights.getSelector().setFilterType(4)
    c_allLights.getSelector().setPattern("*")
    
    """create envir collection"""
    c_allEnvir = charLayer.createCollection("c_charAllEnvir")
    c_allEnvir.getSelector().setFilterType(0)
    c_allEnvir.getSelector().setPattern("ENVIR*")
    o_envirVisibility = c_allEnvir.createOverride("charEnvirVisibility", override.AbsOverride.kTypeId)
    o_envirVisibility.finalize(getListUptoFirstMeshNode("ENVIR")+".primaryVisibility")
    o_envirVisibility.setAttrValue(0)
    
    
    """create collection to turn off all chars from envir layer"""
    c_allChar = charLayer.createCollection("c_charAllChar")
    c_allChar.getSelector().setFilterType(0)
    c_allChar.getSelector().setPattern("CHAR*")
    
    
def createCustomCharLayer(layerName):
    
    """get selected node"""    
    layerName = str(cmds.selectedNodes()[0])
    
    """create render setup instance"""
    rs = renderSetup.instance()
    
    """create and append the render layer"""
    charLayer = rs.createRenderLayer(layerName)
    
    """create all lights collection"""
    c_allLights = charLayer.createCollection("c_AllLights")
    c_allLights.getSelector().setFilterType(4)
    c_allLights.getSelector().setPattern("*")
    
    """create envir collection"""
    c_allEnvir = charLayer.createCollection("c_charAllEnvir")
    c_allEnvir.getSelector().setFilterType(0)
    c_allEnvir.getSelector().setPattern("ENVIR*")
    o_envirVisibility = c_allEnvir.createOverride("charEnvirVisibility", override.AbsOverride.kTypeId)
    o_envirVisibility.finalize(getListUptoFirstMeshNode("ENVIR")+".primaryVisibility")
    o_envirVisibility.setAttrValue(0)
    
    
    """create collection to turn off all chars from envir layer"""
    c_allChar = charLayer.createCollection("c_customcharAllChar")
    c_allChar.getSelector().setFilterType(0)
    c_allChar.getSelector().setPattern(layerName+"*")
    
    
def createPropsLayer(layerName):
        
    """create render setup instance"""
    rs = renderSetup.instance()
    
    """create and append the render layer"""
    propsLayer = rs.createRenderLayer(layerName)
    
    """create all lights collection"""
    c_allLights = propsLayer.createCollection("c_AllLights")
    c_allLights.getSelector().setFilterType(4)
    c_allLights.getSelector().setPattern("*")
    
    """create envir collection"""
    c_allEnvir = propsLayer.createCollection("c_charAllEnvir")
    c_allEnvir.getSelector().setFilterType(0)
    c_allEnvir.getSelector().setPattern("ENVIR*")
    o_envirVisibility = c_allEnvir.createOverride("charEnvirVisibility", override.AbsOverride.kTypeId)
    o_envirVisibility.finalize(getListUptoFirstMeshNode("ENVIR")+".primaryVisibility")
    o_envirVisibility.setAttrValue(0)
    
    """create collection to turn off all chars from envir layer"""
    c_allChar = propsLayer.createCollection("c_envirAllChar")
    c_allChar.getSelector().setFilterType(0)
    c_allChar.getSelector().setPattern("CHAR*")
    o_charVisibility = c_allChar.createOverride("envirCharVisibility", override.AbsOverride.kTypeId)
    o_charVisibility.finalize(getListUptoFirstMeshNode("CHAR")+".primaryVisibility")
    o_charVisibility.setAttrValue(0)
    
    c_allProps = propsLayer.createCollection("c_allProps")
    c_allProps.getSelector().setPattern("Props*")
    o_allPropsVisibility = c_allProps.createOverride("allPropsVisibility", override.AbsOverride.kTypeId)
    o_allPropsVisibility.finalize("ENVIR"+getListUptoFirstMeshNode("Props")+".primaryVisibility")
    o_allPropsVisibility.setAttrValue(1)


createEnvirLayer("ROOM")
createCharLayer("GIRL")
createCustomEnvirLayer("CUSTOM")
createCustomCharLayer()
createPropsLayer("PROPS")
